{% extends 'tracker/base.html' %}

{% block content %}
<h2>Dashboard</h2>

<!-- Add New Entry Button for specific month -->
<a href="{% url 'add_entry' %}?month={{ month }}&year={{ year }}" class="btn btn-primary" style="margin-bottom: 20px;">+ Add Entry for {{ month }}/{{ year }}</a>

<!-- Month and Year Filter Form -->
<form method="get" style="margin-bottom: 20px;">
    <label for="month">Month:</label>
    <select name="month" id="month">
        {% for m, name in months %}
            <option value="{{ m }}" {% if m == month|stringformat:"s" %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
    </select>

    <label for="year">Year:</label>
    <select name="year" id="year">
        {% for y in year_range %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
    </select>

    <button type="submit">Filter</button>
</form>

<div class="summary">
    <p><strong>Total Income:</strong> ₱{{ total_income }}</p>
    <p><strong>Total Expenses:</strong> ₱{{ total_expense }}</p>
    <p><strong>Balance:</strong> ₱{{ balance }}</p>
</div>

<h3>Entries for {{ today|date:"F Y" }}</h3>
<table border="1" cellpadding="5">
    <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Category</th>
        <th>Amount</th>
    </tr>
    {% for entry in entries %}
    <tr>
        <td>{{ entry.date }}</td>
        <td><a href="{% url 'edit_entry' entry.id %}">{{ entry.title }}</a></td>
        <td>{{ entry.entry_type }}</td>
        <td>{{ entry.category.name }}</td>
        <td>₱{{ entry.amount }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="5">No entries this month.</td>
    </tr>
    {% endfor %}
</table>

<!-- Export Button (CSV download) -->
<a href="{% url 'export_csv' %}" class="btn btn-secondary" style="margin-top: 20px;">Export as CSV</a>

<!-- Pie Chart for Expenses by Category -->
<h3>Expense Breakdown by Category</h3>
<canvas class="chart" id="pieChart"></canvas>

<!-- Bar Chart for Monthly Income vs Expenses -->
<h3>Monthly Income vs Expenses</h3>
<canvas class="chart" id="barChart"></canvas>

<!-- Pass data to JavaScript using json_script -->
{{ category_names|json_script:"category_names" }}
{{ category_totals|json_script:"category_totals" }}
{{ income|json_script:"income" }}
{{ expense|json_script:"expense" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Pie Chart for Expense Breakdown by Category
    var categoryNames = JSON.parse(document.getElementById('category_names').textContent);
    var categoryTotals = JSON.parse(document.getElementById('category_totals').textContent);

    var ctxPie = document.getElementById('pieChart').getContext('2d');
    var pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: categoryNames,
            datasets: [{
                label: 'Expense Breakdown',
                data: categoryTotals,
                backgroundColor: ['#FF6347', '#FF9F40', '#FFCD47', '#FF6A6A', '#FFC0CB'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        }
    });

    // Bar Chart for Monthly Income vs Expenses
    var monthlyIncome = JSON.parse(document.getElementById('income').textContent);
    var monthlyExpense = JSON.parse(document.getElementById('expense').textContent);

    var ctxBar = document.getElementById('barChart').getContext('2d');
    var barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: ['Income', 'Expense'],
            datasets: [{
                label: 'Amount',
                data: [monthlyIncome, monthlyExpense],
                backgroundColor: ['#4CAF50', '#F44336'],
                borderColor: ['#388E3C', '#D32F2F'],
                borderWidth: 1
            }]
        }
    });
</script>

{% endblock %}
